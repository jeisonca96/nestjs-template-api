service: nestjs-template-api

frameworkVersion: '4'

useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  stage: prod
  region: ${env:AWS_REGION, 'us-east-1'}
  memorySize: 512
  timeout: 30
  architecture: arm64 # Use ARM64 for better performance and cost
  
  # Environment variables
  environment:
    NODE_ENV: production
    DATABASES_MONGO_URL: ${env:DATABASES_MONGO_URL}
    JWT_SECRET: ${env:JWT_SECRET}
    JWT_EXPIRES_IN: ${env:JWT_EXPIRES_IN, '1d'}
    S3_BUCKET_NAME: ${env:S3_BUCKET_NAME, ''}
    # Add other environment variables as needed
  
  # IAM Role permissions
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource: "arn:aws:s3:::${env:S3_BUCKET_NAME, 'your-bucket-name'}/*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:${self:provider.region}:*:*"
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: "arn:aws:secretsmanager:${self:provider.region}:*:secret:*"
  
  # VPC Configuration (uncomment if your MongoDB is in VPC)
  # vpc:
  #   securityGroupIds:
  #     - sg-xxxxxxxxx
  #   subnetIds:
  #     - subnet-xxxxxxxxx
  #     - subnet-yyyyyyyyy

  # API Gateway settings
  apiGateway:
    shouldStartNameWithService: true
    minimumCompressionSize: 1024 # Enable compression for responses over 1KB
    binaryMediaTypes:
      - 'multipart/form-data'
      - 'image/*'
      - 'application/octet-stream'
  
  # CloudWatch Logs
  logs:
    restApi: true
    
  # Tracing
  tracing:
    lambda: true
    apiGateway: true

custom:
  # Serverless Offline configuration for local testing
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    noPrependStageInUrl: true
    noAuth: true
  
  # Optimization settings
  optimize:
    external:
      - '@nestjs/microservices'
      - '@nestjs/websockets'
      - 'class-transformer/storage'
    excludeFiles: '**/*.spec.ts'

functions:
  main:
    handler: dist/lambda.handler
    events:
      - http:
          method: ANY
          path: /
          cors: true
      - http:
          method: ANY
          path: '{proxy+}'
          cors: true
    # Reserved concurrency (optional, prevents over-provisioning)
    # reservedConcurrency: 10
    
    # Provisioned concurrency for production (optional, reduces cold starts)
    # provisionedConcurrency: 2

plugins:
  - serverless-offline
  - serverless-plugin-optimize

# Package settings
package:
  individually: true
  exclude:
    - node_modules/**
    - test/**
    - coverage/**
    - scripts/**
    - k8s/**
    - docker-compose*.yml
    - Dockerfile*
    - '**/*.spec.ts'
    - '**/*.test.ts'
    - '.git/**'
    - '.github/**'
    - '.vscode/**'
    - '*.md'
  include:
    - dist/**
    - node_modules/@nestjs/**
    - node_modules/@codegenie/**
    - node_modules/express/**
    - src/**/*.hbs

# Resources (optional - add DynamoDB tables, S3 buckets, etc.)
resources:
  Resources:
    # Example: DynamoDB table for rate limiting
    # RateLimitTable:
    #   Type: AWS::DynamoDB::Table
    #   Properties:
    #     TableName: ${self:service}-rate-limit-${self:provider.stage}
    #     AttributeDefinitions:
    #       - AttributeName: id
    #         AttributeType: S
    #     KeySchema:
    #       - AttributeName: id
    #         KeyType: HASH
    #     BillingMode: PAY_PER_REQUEST
    #     TimeToLiveSpecification:
    #       AttributeName: ttl
    #       Enabled: true
    
    # CloudWatch Log Group with retention
    MainLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/lambda/${self:service}-prod-main
        RetentionInDays: 30

  # CloudFormation Outputs
  Outputs:
    ApiGatewayRestApiId:
      Description: API Gateway REST API ID
      Value:
        Ref: ApiGatewayRestApi
      Export:
        Name: ${self:service}-prod-ApiGatewayRestApiId
    
    ApiEndpoint:
      Description: API Gateway Endpoint URL
      Value:
        Fn::Sub: https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/prod
    
    MainLambdaFunctionArn:
      Description: Main Lambda Function ARN
      Value:
        Fn::GetAtt:
          - MainLambdaFunction
          - Arn
      Export:
        Name: ${self:service}-prod-MainLambdaFunctionArn
